<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kano ë¶„ì„ ëŒ€ì‹œë³´ë“œ Pro (ì˜¤ì°¨ë²”ìœ„ í¬í•¨)</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <!-- SheetJS (Excel/CSV Parsing) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-btn.active { border-bottom: 3px solid #0f172a; color: #0f172a; font-weight: 800; }
        /* Video Responsive Helper */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.5rem; margin-top: 0.5rem; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Modal Styles */
        .modal { transition: opacity 0.2s ease-in-out; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }

        /* Loading Spinner */
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-slate-400 hover:text-slate-800 transition-colors flex items-center gap-1 text-sm font-medium pr-4 border-r border-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    ë©”ì¸ìœ¼ë¡œ
                </a>
                <div class="flex items-center gap-2">
                    <span class="bg-slate-800 text-white rounded p-1 font-black px-2">PRO</span>
                    <h1 class="text-xl font-bold text-slate-800">Kano Analysis <span class="text-slate-500">Dashboard</span></h1>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative group flex items-center gap-2">
                    <input type="password" id="api-key-input" oninput="saveApiKey(this.value)" placeholder="Gemini API Key ì…ë ¥" class="border border-gray-300 rounded px-3 py-1 text-xs w-40 focus:w-64 transition-all outline-none focus:border-slate-800 bg-slate-50">
                    <button onclick="openApiKeyModal()" class="text-xs text-gray-400 underline hover:text-slate-800 cursor-pointer">
                        í‚¤ ë°œê¸‰ ì•ˆë‚´
                    </button>
                </div>
            </div>
        </div>
        <!-- Tabs -->
        <div class="container mx-auto px-6 mt-2">
            <div class="flex gap-8 border-b border-gray-200">
                <button onclick="switchTab('design')" id="tab-design" class="tab-btn active pb-3 px-1 text-sm transition-colors hover:text-slate-800">1. ì„¤ë¬¸ ì„¤ê³„</button>
                <button onclick="switchTab('collect')" id="tab-collect" class="tab-btn pb-3 px-1 text-sm transition-colors hover:text-slate-800">2. ë°ì´í„° ì…ë ¥</button>
                <button onclick="switchTab('analyze')" id="tab-analyze" class="tab-btn pb-3 px-1 text-sm transition-colors hover:text-slate-800">3. ì •ë°€ ë¶„ì„ (í†µê³„)</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 flex-grow">
        
        <!-- STEP 1: Survey Design -->
        <div id="step-design" class="step-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Form -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Manual Input -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-fit">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            ê¸°ëŠ¥ ì§ì ‘ ì¶”ê°€
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ê¸°ëŠ¥/ì„œë¹„ìŠ¤ ëª…</label>
                                <input type="text" id="feat-name" placeholder="ì˜ˆ: ë‹¤í¬ëª¨ë“œ" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-slate-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª… (ì´ë¯¸ì§€/ìœ íŠœë¸Œ URL ê°€ëŠ¥)</label>
                                <input type="text" id="feat-desc" placeholder="ì„¤ëª…ê¸€ ë˜ëŠ” https://..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-slate-500 outline-none">
                            </div>
                            <button onclick="addFeature()" class="w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-900 transition-all">ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>
                        </div>
                    </div>

                    <!-- AI Generator -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-fit relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-slate-200 rounded-full opacity-50 blur-xl"></div>
                        <h3 class="text-lg font-bold mb-2 flex items-center gap-2 text-slate-800">
                            <span>âœ¨</span> AI ì•„ì´ë””ì–´ ì œì•ˆ
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">ì„œë¹„ìŠ¤ ì£¼ì œë¥¼ ì…ë ¥í•˜ë©´ ë¶„ì„í•  ê¸°ëŠ¥ í›„ë³´ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</p>
                        
                        <div class="space-y-3">
                            <input type="text" id="ai-product-context" placeholder="ì˜ˆ: 20ëŒ€ë¥¼ ìœ„í•œ ì§ í…Œí¬ ê°€ê³„ë¶€ ì•±" class="w-full p-2 border border-slate-200 rounded focus:ring-2 focus:ring-slate-500 outline-none bg-slate-50">
                            <button onclick="generateFeaturesWithAI()" id="btn-gen-ai" class="w-full bg-white border border-slate-300 text-slate-700 py-2 rounded font-bold hover:bg-slate-50 transition-all flex justify-center items-center gap-2 shadow-sm">
                                <span>ì•„ì´ë””ì–´ ìƒì„±í•˜ê¸°</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- List & Preview -->
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">ë“±ë¡ëœ ê¸°ëŠ¥ ëª©ë¡ (<span id="feat-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <button onclick="openFormGuide()" class="bg-amber-100 border border-amber-200 text-amber-800 px-4 py-2 rounded text-sm font-bold hover:bg-amber-200 flex items-center gap-2 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ì„¤ë¬¸ ê°€ì´ë“œ
                            </button>
                            <button onclick="copyForGoogleForm()" class="bg-white border border-gray-300 text-slate-700 px-4 py-2 rounded text-sm font-bold hover:bg-gray-50 flex items-center gap-2 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                ì§ˆë¬¸ í…ìŠ¤íŠ¸ ë³µì‚¬
                            </button>
                        </div>
                    </div>
                    
                    <div id="feature-list" class="space-y-4">
                        <div class="text-center py-12 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-slate-50">
                            ì•„ì§ ë“±ë¡ëœ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ AIì—ê²Œ ì•„ì´ë””ì–´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš”.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Data Collection -->
        <div id="step-collect" class="step-content">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-slate-800">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h3>
                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-bold">3ì—´ ë°ì´í„° (ê¸ì •/ë¶€ì •/ì¤‘ìš”ë„)</span>
                    </div>
                    
                    <div class="mb-6 p-4 bg-slate-50 rounded border border-slate-200 text-sm text-slate-600">
                        <p class="mb-2 font-bold">ğŸ“‹ ì…ë ¥ í˜•ì‹ ì•ˆë‚´</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>ê° ê¸°ëŠ¥ë§ˆë‹¤ <strong>3ê°œì˜ ì—´(Column)</strong>ì´ ìˆœì„œëŒ€ë¡œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤: <strong>[ê¸ì •ì‘ë‹µ] [ë¶€ì •ì‘ë‹µ] [ì¤‘ìš”ë„(1~5)]</strong></li>
                            <li>ì—‘ì…€ì´ë‚˜ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ë³µì‚¬(Ctrl+C)í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”(Ctrl+V).</li>
                            <li>í…ìŠ¤íŠ¸(ì¢‹ë‹¤, ì‹«ë‹¤ ë“±)ì™€ ìˆ«ì(1~5) ëª¨ë‘ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>

                    <textarea id="data-input" class="w-full h-48 p-4 bg-white border border-gray-300 rounded-lg text-xs font-mono focus:ring-2 focus:ring-slate-500 outline-none shadow-inner" placeholder="ì—¬ê¸°ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    
                    <div class="flex gap-4 mt-4">
                        <button onclick="processData()" class="flex-grow bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-all shadow-md flex justify-center items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            ë°ì´í„° ë¶„ì„ ì‹œì‘
                        </button>
                        <button onclick="loadSampleData()" class="px-6 py-3 border border-gray-300 text-gray-600 rounded-lg font-bold hover:bg-gray-50 transition-colors">
                            ìƒ˜í”Œ ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3: Analysis Result -->
        <div id="step-analyze" class="step-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Bubble Chart with Error Bars -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-slate-800">ì „ëµ ë¶„ì„ ë§µ (Statistic View)</h4>
                                <p class="text-xs text-gray-500 mt-1">
                                    â€¢ ì› í¬ê¸°: ì¤‘ìš”ë„ (í´ìˆ˜ë¡ ì¤‘ìš”)<br>
                                    â€¢ ì‹­ìì„ (Crosshair): <strong>í‘œì¤€ ì˜¤ì°¨(Standard Error)</strong> ë²”ìœ„. ì„ ì´ ê¸¸ìˆ˜ë¡ ì‘ë‹µ í¸ì°¨ê°€ í½ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-slate-400">Better(ë§Œì¡±) vs Worse(ë¶ˆë§Œì¡±)</span>
                            </div>
                        </div>
                        <div class="relative h-[500px] w-full">
                            <canvas id="resultChart"></canvas>
                        </div>
                        <div class="mt-4 flex justify-center gap-4 text-xs text-gray-500 flex-wrap border-t border-gray-100 pt-4">
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-500 opacity-80"></span>Must-be (í•„ìˆ˜)</div>
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500 opacity-80"></span>One-dimensional (ì¼ì›)</div>
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-rose-500 opacity-80"></span>Attractive (ë§¤ë ¥)</div>
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-400 opacity-80"></span>Indifferent (ë¬´ê´€ì‹¬)</div>
                        </div>
                    </div>

                    <!-- AI Analysis Result Area -->
                    <div id="ai-analysis-container" class="bg-slate-800 text-white p-6 rounded-xl shadow-lg relative overflow-hidden hidden">
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <h4 class="text-lg font-bold flex items-center gap-2"><span>âœ¨</span> AI í†µê³„ ë¶„ì„ ë¦¬í¬íŠ¸</h4>
                            <button onclick="analyzeWithAI()" id="btn-analyze-ai" class="bg-white/10 hover:bg-white/20 border border-white/20 text-xs px-3 py-1.5 rounded transition-all">
                                ë¦¬í¬íŠ¸ ì¬ìƒì„±
                            </button>
                        </div>
                        <div id="ai-analysis-content" class="text-sm text-slate-300 leading-relaxed space-y-2 markdown-body">
                            <p class="animate-pulse flex items-center gap-2"><span class="spinner"></span> ì˜¤ì°¨ ë²”ìœ„ì™€ ì¤‘ìš”ë„ë¥¼ í¬í•¨í•˜ì—¬ ë°ì´í„°ë¥¼ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                    </div>
                </div>

                <!-- Result Table -->
                <div class="lg:col-span-1 bg-white p-0 rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[650px]">
                    <div class="p-4 border-b border-gray-100 bg-slate-50">
                        <h4 class="text-lg font-bold text-slate-800">ìƒì„¸ ë°ì´í„°</h4>
                    </div>
                    <div class="overflow-y-auto flex-grow">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-white text-gray-500 font-medium border-b sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 bg-slate-50">ê¸°ëŠ¥ëª…</th>
                                    <th class="p-3 bg-slate-50">ìœ í˜•</th>
                                    <th class="p-3 bg-slate-50 text-right">Better<br><span class="text-[10px] font-normal">(Â±SE)</span></th>
                                    <th class="p-3 bg-slate-50 text-right">Worse<br><span class="text-[10px] font-normal">(Â±SE)</span></th>
                                    <th class="p-3 bg-slate-50 text-right text-purple-700">Imp.</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body" class="divide-y divide-gray-100 bg-white">
                                <!-- Results here -->
                                <tr><td colspan="5" class="p-8 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-100 bg-white">
                        <button onclick="analyzeWithAI()" class="w-full bg-gradient-to-r from-slate-700 to-slate-800 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all flex justify-center items-center gap-2">
                            <span>âœ¨ AI í†µê³„ ë¦¬í¬íŠ¸ ìƒì„±</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Guide Modal (Form) -->
    <div id="form-guide-modal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform scale-100 transition-transform">
            <div class="bg-slate-800 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    [Pro] ì„¤ë¬¸ ì‘ì„± ê°€ì´ë“œ
                </h3>
                <button onclick="closeFormGuide()" class="text-slate-400 hover:text-white rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-6 text-slate-700 max-h-[70vh] overflow-y-auto">
                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800 text-lg">1. ì§ˆë¬¸ êµ¬ì¡° (3ë‹¨ê³„)</h4>
                    <p class="text-sm">ê° ê¸°ëŠ¥ë§ˆë‹¤ <strong>ê¸ì • ì§ˆë¬¸ â†’ ë¶€ì • ì§ˆë¬¸ â†’ ì¤‘ìš”ë„ ì§ˆë¬¸</strong> ìˆœì„œë¡œ ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-800 text-lg">2. ì„ íƒì§€ êµ¬ì„±</h4>
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <p class="font-bold text-blue-800 text-sm mb-1">Q1. ê¸ì • & Q2. ë¶€ì • (ê¸°ì¡´ê³¼ ë™ì¼)</p>
                        <p class="text-xs text-gray-500 mb-2">1.ì¢‹ë‹¤ ~ 5.ì‹«ë‹¤ (5ì  ì²™ë„)</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded border border-purple-100">
                        <p class="font-bold text-purple-800 text-sm mb-2">ğŸŸ£ Q3. (ì¤‘ìš”ë„) ì´ ê¸°ëŠ¥ì€ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•©ë‹ˆê¹Œ?</p>
                        <ul class="text-xs font-mono text-gray-700 space-y-1">
                            <li>1. ì „í˜€ ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.</li>
                            <li>2. ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.</li>
                            <li>3. ë³´í†µì´ë‹¤.</li>
                            <li>4. ì¤‘ìš”í•˜ë‹¤.</li>
                            <li>5. ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-end">
                <button onclick="closeFormGuide()" class="px-5 py-2.5 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold transition-colors">
                    í™•ì¸í–ˆìŠµë‹ˆë‹¤
                </button>
            </div>
        </div>
    </div>

    <!-- API Key Guide Modal -->
    <div id="api-key-modal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden transform scale-100 transition-transform">
            <div class="bg-slate-800 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center gap-2">Gemini API í‚¤ ì„¤ì •</h3>
                <button onclick="closeApiKeyModal()" class="text-slate-400 hover:text-white rounded-full p-1"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">Google AI Studioì—ì„œ ë¬´ë£Œ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block text-center bg-gray-100 hover:bg-gray-200 py-3 rounded text-slate-800 font-bold text-sm">í‚¤ ë°œê¸‰ë°›ìœ¼ëŸ¬ ê°€ê¸° â†—</a>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-opacity opacity-0 pointer-events-none z-50">Message</div>

    <script>
        // --- Global State ---
        let features = []; 
        let analysisResults = []; 

        // --- Helper: API Key ---
        function getApiKey() {
            let key = document.getElementById('api-key-input').value.trim();
            if (!key) {
                key = localStorage.getItem('gemini_api_key') || "";
                if(key) document.getElementById('api-key-input').value = key;
            }
            if(!key) {
                showToast('âš ï¸ ìƒë‹¨ì— Gemini API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('api-key-input').focus();
                return null;
            }
            return key;
        }

        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) document.getElementById('api-key-input').value = savedKey;
        });
        function saveApiKey(key) { localStorage.setItem('gemini_api_key', key); }

        // --- Modal & Tab Utils ---
        function switchTab(tabId) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${tabId}`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        function openFormGuide() { document.getElementById('form-guide-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('form-guide-modal').classList.add('active'), 10); }
        function closeFormGuide() { document.getElementById('form-guide-modal').classList.remove('active'); setTimeout(() => document.getElementById('form-guide-modal').classList.add('hidden'), 200); }
        function openApiKeyModal() { document.getElementById('api-key-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('api-key-modal').classList.add('active'), 10); }
        function closeApiKeyModal() { document.getElementById('api-key-modal').classList.remove('active'); setTimeout(() => document.getElementById('api-key-modal').classList.add('hidden'), 200); }
        document.getElementById('form-guide-modal').classList.add('hidden');
        document.getElementById('api-key-modal').classList.add('hidden');

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        // --- Step 1: Design Logic ---
        function addFeature(customName = null, customDesc = null) {
            const name = customName || document.getElementById('feat-name').value.trim();
            const desc = customDesc || document.getElementById('feat-desc').value.trim();
            if(!name) { showToast('ê¸°ëŠ¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if(features.length >= 10) { showToast('ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
            const feature = { id: Date.now() + Math.random(), name, desc };
            features.push(feature);
            if(!customName) { document.getElementById('feat-name').value = ''; document.getElementById('feat-desc').value = ''; }
            renderFeatures();
        }

        async function generateFeaturesWithAI() {
            const key = getApiKey(); if (!key) return;
            const context = document.getElementById('ai-product-context').value.trim();
            if (!context) { showToast('ì„œë¹„ìŠ¤ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const btn = document.getElementById('btn-gen-ai');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner"></div> ìƒì„± ì¤‘...`; btn.disabled = true;
            const prompt = `Role: Senior PM. Task: Suggest 5 distinct features for: "${context}". Output: JSON Array of objects with 'name' and 'desc'. Return ONLY JSON. Language: Korean.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0) throw new Error("AI ì‘ë‹µ ì˜¤ë¥˜");
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const newFeatures = JSON.parse(text);
                features = []; newFeatures.forEach(f => addFeature(f.name, f.desc));
                showToast('âœ¨ 5ê°€ì§€ ì•„ì´ë””ì–´ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) { console.error(error); showToast('AI ì˜¤ë¥˜: ' + error.message); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        function renderMediaOrText(content) {
            if (!content) return '';
            const ytMatch = content.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (ytMatch && ytMatch[1]) return `<div class="video-container bg-black"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            if (/\.(jpeg|jpg|gif|png|webp|svg)($|\?)/i.test(content) || (content.startsWith('http') && content.includes('images'))) return `<img src="${content}" class="w-full h-40 object-cover rounded mt-2 border border-gray-100">`;
            return `<p class="text-sm text-gray-500 mt-1 whitespace-pre-wrap">${content}</p>`;
        }

        function removeFeature(id) { features = features.filter(f => f.id !== id); renderFeatures(); }
        
        function renderFeatures() {
            const listEl = document.getElementById('feature-list');
            document.getElementById('feat-count').innerText = features.length;
            if(features.length === 0) { listEl.innerHTML = `<div class="text-center py-12 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">ì•„ì§ ë“±ë¡ëœ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ AIì—ê²Œ ì•„ì´ë””ì–´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš”.</div>`; return; }
            listEl.innerHTML = features.map((f, idx) => `
                <div class="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-start group hover:shadow-md transition-all">
                    <div class="w-full mr-4">
                        <div class="flex items-center gap-2">
                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded font-bold">#${idx + 1}</span>
                            <h4 class="font-bold text-slate-800">${f.name}</h4>
                        </div>
                        ${renderMediaOrText(f.desc)}
                        <div class="mt-3 text-xs text-gray-400 bg-gray-50 p-2 rounded hidden group-hover:block transition-all">
                            <p>Q1(ê¸ì •) / Q2(ë¶€ì •) / <strong>Q3(ì¤‘ìš”ë„)</strong> ìë™ ìƒì„±ë¨</p>
                        </div>
                    </div>
                    <button onclick="removeFeature(${f.id})" class="text-gray-400 hover:text-red-500 p-1 flex-shrink-0"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
            `).join('');
        }

        function copyForGoogleForm() {
            if(features.length === 0) { showToast('ë³µì‚¬í•  ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            let text = "=== [í•„ë…] ì„¤ë¬¸ ì‘ì„± ê°€ì´ë“œ (ì¤‘ìš”ë„ í¬í•¨) ===\nì§ˆë¬¸ ìœ í˜•: 'ê°ê´€ì‹ ì§ˆë¬¸' / í•„ìˆ˜ ì²´í¬ / ê¸°ëŠ¥ë‹¹ 3ê°œ ì§ˆë¬¸\n=====================================\n\n";
            features.forEach((f, i) => {
                text += `[ì„¹ì…˜ ${i+1}: ${f.name}]\n`;
                text += f.desc.startsWith('http') ? `ì°¸ê³  ìë£Œ: ${f.desc}\n\n` : `ì„¤ëª…: ${f.desc}\n\n`;
                text += `Q1. (ê¸ì •) ${f.name} ê¸°ëŠ¥ì´ ì œê³µëœë‹¤ë©´ ì–´ë– ì‹œê² ìŠµë‹ˆê¹Œ?\n[ì„ íƒì§€]\n1. ì¢‹ë‹¤.\n2. ë‹¹ì—°í•˜ë‹¤.\n3. ì¤‘ë¦½ì´ë‹¤.\n4. ìˆì–´ë„ ìƒê´€ì—†ë‹¤.\n5. ë§ˆìŒì— ì•ˆ ë“ ë‹¤.\n\n`;
                text += `Q2. (ë¶€ì •) ${f.name} ê¸°ëŠ¥ì´ ì œê³µë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì–´ë– ì‹œê² ìŠµë‹ˆê¹Œ?\n[ì„ íƒì§€]\n1. ì—†ëŠ” ê²Œ ë‚˜ì„ ê²ƒ ê°™ë‹¤.\n2. ë‹¹ì—°íˆ ì—†ì–´ë„ ëœë‹¤.\n3. ì¤‘ë¦½ì´ë‹¤.\n4. ì•„ì‰½ì§€ë§Œ ì—†ì–´ë„ ê´œì°®ë‹¤.\n5. ì—†ìœ¼ë©´ ì•ˆëœë‹¤.\n\n`;
                text += `Q3. (ì¤‘ìš”ë„) ${f.name} ê¸°ëŠ¥ì€ ê·€í•˜ì—ê²Œ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•©ë‹ˆê¹Œ?\n[ì„ íƒì§€]\n1. ì „í˜€ ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.\n2. ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.\n3. ë³´í†µì´ë‹¤.\n4. ì¤‘ìš”í•˜ë‹¤.\n5. ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.\n\n--------------------------------\n`;
            });
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "0"; textArea.style.top = "0";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); showToast('3ë‹¨ê³„ ì§ˆë¬¸(ê¸ì •/ë¶€ì •/ì¤‘ìš”ë„) í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch (err) { showToast('ë³µì‚¬ ì‹¤íŒ¨'); }
            document.body.removeChild(textArea);
        }

        // --- Step 2: Data Processing (Calculates Standard Error) ---
        const kanoMap = [ ['Q', 'A', 'A', 'A', 'O'], ['R', 'I', 'I', 'I', 'M'], ['R', 'I', 'I', 'I', 'M'], ['R', 'I', 'I', 'I', 'M'], ['R', 'R', 'R', 'R', 'Q'] ];
        
        function mapScore(text) {
            const t = String(text).trim();
            if(t.includes('1') || t.includes('ì¢‹ë‹¤') || t.includes('ì—†ëŠ” ê²Œ') || t.includes('ì „í˜€')) return 0;
            if(t.includes('2') || t.includes('ë‹¹ì—°') || t.includes('ì¤‘ìš”í•˜ì§€')) return 1;
            if(t.includes('3') || t.includes('ì¤‘ë¦½') || t.includes('ìƒê´€') || t.includes('ë³´í†µ')) return 2;
            if(t.includes('4') || t.includes('ì°¸ì„') || t.includes('ê´œì°®') || t.includes('ì¤‘ìš”í•˜ë‹¤')) return 3;
            if(t.includes('5') || t.includes('ë§ˆìŒì— ì•ˆ') || t.includes('ì—†ìœ¼ë©´') || t.includes('ë§¤ìš°')) return 4;
            return 2; 
        }

        function loadSampleData() {
            if(features.length === 0) { addFeature('ìë™ ì €ì¥', 'ì…ë ¥ ì¤‘ ë‚´ìš© ìë™ ì €ì¥'); addFeature('ë‹¤í¬ ëª¨ë“œ', 'ëˆˆì´ í¸ì•ˆí•œ ì–´ë‘ìš´ í™”ë©´'); }
            let csv = "";
            for(let i=0; i<20; i++) {
                let row = [];
                features.forEach(() => { 
                    row.push(Math.floor(Math.random()*5)+1); // Pos
                    row.push(Math.floor(Math.random()*5)+1); // Neg
                    row.push(Math.floor(Math.random()*5)+1); // Imp
                });
                csv += row.join(',') + "\n";
            }
            document.getElementById('data-input').value = csv;
            showToast('ìƒ˜í”Œ ë°ì´í„° (3ì—´ í˜•ì‹) ë¡œë“œ ì™„ë£Œ');
        }

        function processData() {
            const rawText = document.getElementById('data-input').value.trim();
            if(!rawText) { showToast('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if(features.length === 0) { showToast('ê¸°ëŠ¥ ì •ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.'); switchTab('design'); return; }

            const rows = rawText.split('\n');
            const results = features.map(f => ({ 
                id: f.id, name: f.name, 
                counts: { A:0, O:0, M:0, I:0, R:0, Q:0 }, 
                impSum: 0, total: 0,
                // For SD calc
                betterCounts: 0, worseCounts: 0 
            }));

            rows.forEach(row => {
                if(!row.trim()) return;
                const cols = row.split(/,|\t/);
                features.forEach((feat, idx) => {
                    const colIdx = idx * 3;
                    if(cols.length <= colIdx + 2) return;

                    const func = mapScore(cols[colIdx]);
                    const dys = mapScore(cols[colIdx+1]);
                    const imp = mapScore(cols[colIdx+2]) + 1;

                    const cat = kanoMap[func][dys];
                    results[idx].counts[cat]++;
                    results[idx].impSum += imp;
                    results[idx].total++;
                    
                    // Track for SE calculation
                    if(['A','O'].includes(cat)) results[idx].betterCounts++;
                    if(['O','M'].includes(cat)) results[idx].worseCounts++;
                });
            });

            analysisResults = results.map(res => {
                const { A, O, M, I, Q, R } = res.counts;
                const totalValid = A + O + M + I; // Denominator usually excludes Q,R
                // But for robust SE, we use total responses or total valid? Let's use total valid.
                
                const pBetter = totalValid ? (res.betterCounts / totalValid) : 0;
                const pWorse = totalValid ? (res.worseCounts / totalValid) : 0;
                
                // Standard Error of Proportion: sqrt(p(1-p)/n)
                const seBetter = totalValid ? Math.sqrt((pBetter * (1 - pBetter)) / totalValid) : 0;
                const seWorse = totalValid ? Math.sqrt((pWorse * (1 - pWorse)) / totalValid) : 0;

                const avgImp = res.total ? (res.impSum / res.total) : 0;
                
                // Find dominant category
                let maxCat = 'I'; let maxVal = -1;
                for(const [cat, val] of Object.entries(res.counts)) { if(cat !== 'Q' && cat !== 'R' && val > maxVal) { maxVal = val; maxCat = cat; } }
                
                return { 
                    ...res, 
                    better: pBetter, 
                    worse: -pWorse, // Plot as negative
                    seBetter: seBetter,
                    seWorse: seWorse, // This is positive
                    avgImp, 
                    category: maxCat 
                };
            });

            renderCharts();
            switchTab('analyze');
        }

        // --- AI Analysis ---
        async function analyzeWithAI() {
            const key = getApiKey(); if (!key) return;
            if (analysisResults.length === 0) { showToast('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const container = document.getElementById('ai-analysis-container');
            const content = document.getElementById('ai-analysis-content');
            const btn = document.getElementById('btn-analyze-ai');
            
            container.classList.remove('hidden');
            content.innerHTML = `<div class="flex items-center gap-2"><div class="spinner"></div><p>ì¤‘ìš”ë„ì™€ ì˜¤ì°¨ë²”ìœ„ë¥¼ ê³ ë ¤í•˜ì—¬ ë¶„ì„ ì¤‘...</p></div>`;
            btn.disabled = true;

            const summaryData = analysisResults.map(r => {
                // Determine Quadrant based on Coefficients (matching the Chart)
                let quadrant = "Indifferent";
                if (r.better > 0.5) {
                    if (r.worse < -0.5) quadrant = "One-dimensional (ì¼ì›ì )";
                    else quadrant = "Attractive (ë§¤ë ¥ì )";
                } else {
                    if (r.worse < -0.5) quadrant = "Must-be (ë‹¹ì—°ì )";
                    else quadrant = "Indifferent (ë¬´ê´€ì‹¬)";
                }

                return {
                    feature: r.name,
                    // Pass the Quadrant as the main category for AI consistency
                    analysis_result: quadrant, 
                    // Also pass detailed stats
                    details: {
                        satisfaction_better: `${r.better.toFixed(2)} (Â±${r.seBetter.toFixed(2)})`,
                        dissatisfaction_worse: `${r.worse.toFixed(2)} (Â±${r.seWorse.toFixed(2)})`,
                        importance: r.avgImp.toFixed(2),
                        dominant_response_type: r.category // The count-based result
                    }
                };
            });

            const prompt = `
                Role: Senior Product Manager Expert in Kano Model.
                Task: Analyze the provided Kano analysis results and summarize the strategy in Korean.
                Data: ${JSON.stringify(summaryData)}
                
                Constraint:
                1. STRICTLY use the 'analysis_result' field in the data for the category (Must-be, etc.). DO NOT hallucinate based on feature names.
                2. If the 'analysis_result' is 'Indifferent', do NOT call it 'Attractive' even if the feature name (e.g., Dark Mode) sounds like it should be.
                3. Focus on High Importance items.
                4. Mention standard error if it's high (>0.15).
                
                Output: Strategic summary in Korean (Markdown).
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0) throw new Error("AI ì‘ë‹µ ì—†ìŒ");
                content.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (error) { console.error(error); content.innerText = 'ì˜¤ë¥˜: ' + error.message; } 
            finally { btn.disabled = false; }
        }

        // --- Custom Error Bar Plugin ---
        const errorBarPlugin = {
            id: 'errorBar',
            afterDatasetsDraw(chart, args, options) {
                const { ctx } = chart;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((element, index) => {
                        const data = dataset.data[index];
                        // If no SE data, skip
                        if(data.seX === undefined || data.seY === undefined) return;

                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        // Current Point Coordinates
                        const x = xAxis.getPixelForValue(data.x);
                        const y = yAxis.getPixelForValue(data.y);
                        
                        // Error Bar Ends
                        // X axis is 'Worse' (Negative). SE is +/-. 
                        const xMin = xAxis.getPixelForValue(data.x - data.seX);
                        const xMax = xAxis.getPixelForValue(data.x + data.seX);
                        const yMin = yAxis.getPixelForValue(data.y - data.seY);
                        const yMax = yAxis.getPixelForValue(data.y + data.seY);

                        ctx.save();
                        ctx.strokeStyle = 'rgba(100, 116, 139, 0.6)'; // Slate-500 equivalent
                        ctx.lineWidth = 1.5;
                        
                        // Horizontal Line (Worse Error)
                        ctx.beginPath();
                        ctx.moveTo(xMin, y);
                        ctx.lineTo(xMax, y);
                        ctx.stroke();
                        
                        // Vertical Line (Better Error)
                        ctx.beginPath();
                        ctx.moveTo(x, yMin);
                        ctx.lineTo(x, yMax);
                        ctx.stroke();
                        
                        // Draw Caps (Tips)
                        const capSize = 4;
                        
                        // H-Cap Left
                        ctx.beginPath(); ctx.moveTo(xMin, y - capSize); ctx.lineTo(xMin, y + capSize); ctx.stroke();
                        // H-Cap Right
                        ctx.beginPath(); ctx.moveTo(xMax, y - capSize); ctx.lineTo(xMax, y + capSize); ctx.stroke();
                        // V-Cap Top
                        ctx.beginPath(); ctx.moveTo(x - capSize, yMax); ctx.lineTo(x + capSize, yMax); ctx.stroke();
                        // V-Cap Bottom
                        ctx.beginPath(); ctx.moveTo(x - capSize, yMin); ctx.lineTo(x + capSize, yMin); ctx.stroke();

                        ctx.restore();
                    });
                });
            }
        };

        // --- Visualization ---
        let resultChartInstance = null;
        function renderCharts() {
            // Register Plugin
            Chart.register(errorBarPlugin);

            // Table
            const tbody = document.getElementById('result-table-body');
            tbody.innerHTML = analysisResults.map(res => {
                const catMap = { 'M':'Must-be', 'O':'One-dimensional', 'A':'Attractive', 'I':'Indifferent', 'R':'Reverse', 'Q':'Quest.' };
                const colorMap = { 'M':'text-amber-600', 'O':'text-blue-600', 'A':'text-rose-600', 'I':'text-gray-500', 'R':'text-red-600', 'Q':'text-gray-400' };
                const impStyle = res.avgImp >= 4.0 ? 'font-bold text-purple-700 bg-purple-50' : 'text-gray-600';
                return `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-gray-50">
                        <td class="p-3 font-medium text-slate-700">${res.name}</td>
                        <td class="p-3 font-bold ${colorMap[res.category]}">${catMap[res.category]}</td>
                        <td class="p-3 text-right text-blue-600">
                            ${res.better.toFixed(2)} 
                            <span class="text-[10px] text-gray-400 block">Â±${res.seBetter.toFixed(2)}</span>
                        </td>
                        <td class="p-3 text-right text-amber-600">
                            ${res.worse.toFixed(2)}
                            <span class="text-[10px] text-gray-400 block">Â±${res.seWorse.toFixed(2)}</span>
                        </td>
                        <td class="p-3 text-right ${impStyle}">${res.avgImp.toFixed(2)}</td>
                    </tr>`;
            }).join('');

            // Chart
            const ctx = document.getElementById('resultChart').getContext('2d');
            if(resultChartInstance) resultChartInstance.destroy();

            const dataPoints = analysisResults.map(res => ({
                x: res.worse,
                y: res.better,
                r: res.avgImp * 6, // Radius by Importance
                // Custom props for plugin
                seX: res.seWorse,
                seY: res.seBetter,
                label: res.name,
                category: res.category,
                imp: res.avgImp.toFixed(2)
            }));

            resultChartInstance = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Features',
                        data: dataPoints,
                        backgroundColor: (ctx) => {
                            const cat = ctx.raw?.category;
                            if(cat === 'M') return 'rgba(245, 158, 11, 0.7)';
                            if(cat === 'O') return 'rgba(37, 99, 235, 0.7)';
                            if(cat === 'A') return 'rgba(244, 63, 94, 0.7)';
                            return 'rgba(156, 163, 175, 0.7)';
                        },
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'ë¶ˆë§Œì¡± ê³„ìˆ˜ (Worse)', font:{weight:'bold'} }, 
                            min: -1, max: 0, 
                            grid: { color: '#e2e8f0' } 
                        },
                        y: { 
                            title: { display: true, text: 'ë§Œì¡± ê³„ìˆ˜ (Better)', font:{weight:'bold'} }, 
                            min: 0, max: 1, 
                            grid: { color: '#e2e8f0' } 
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.label} (${ctx.raw.category})`,
                                afterLabel: (ctx) => {
                                    const r = ctx.raw;
                                    return [
                                        `Imp: ${r.imp}`,
                                        `Better: ${r.y.toFixed(2)} (Â±${r.seY.toFixed(2)})`,
                                        `Worse: ${r.x.toFixed(2)} (Â±${r.seX.toFixed(2)})`
                                    ];
                                }
                            }
                        },
                        annotation: { annotations: {
                            lineH: { type: 'line', yMin: 0.5, yMax: 0.5, borderColor: 'rgba(0,0,0,0.1)', borderWidth: 2, borderDash: [6,6] },
                            lineV: { type: 'line', xMin: -0.5, xMax: -0.5, borderColor: 'rgba(0,0,0,0.1)', borderWidth: 2, borderDash: [6,6] },
                            labelM: { type: 'label', xValue: -0.9, yValue: 0.1, content: 'Must-be', color: 'rgba(245, 158, 11, 0.3)', font:{size:16, weight:'bold'} },
                            labelO: { type: 'label', xValue: -0.9, yValue: 0.9, content: 'One-dimensional', color: 'rgba(37, 99, 235, 0.3)', font:{size:16, weight:'bold'} },
                            labelA: { type: 'label', xValue: -0.1, yValue: 0.9, content: 'Attractive', color: 'rgba(244, 63, 94, 0.3)', font:{size:16, weight:'bold'} },
                            labelI: { type: 'label', xValue: -0.1, yValue: 0.1, content: 'Indifferent', color: 'rgba(156, 163, 175, 0.3)', font:{size:16, weight:'bold'} }
                        }}
                    }
                }
            });
        }

        // --- Toast Utils ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }
    </script>
</body>
</html>
